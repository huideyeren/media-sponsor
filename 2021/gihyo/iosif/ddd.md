# PyCon JP 2021 イベントレポート

## セッション「Python x DDD!! - Python で学ぶ実践的なドメイン駆動設計とレイヤード・アーキテクチャ」 - 池内 孝啓氏

池内氏の「[Python x DDD!! - Python で学ぶ実践的なドメイン駆動設計とレイヤード・アーキテクチャ](https://2021.pycon.jp/time-table/?id=272415)」というセッションの紹介をいたします。

池内氏は株式会社HakaliのCTOとしてメンタルウェルネスアプリ・Awarefyの事業・開発における責任者として活動しているエンジニアで、PythonのほかにDart(Flutter)やGo、TypeScriptを使いこなしています。

このセッションではFastAPIを使った、Pythonにおけるドメイン駆動設計とレイヤード・アーキテクチャ、とりわけオニオン・アーキテクチャの実践に焦点を当てて紹介しています。レイヤード・アーキテクチャとしてはロバート・C・マーチン氏、通称ボブおじさんのクリーン・アーキテクチャがはじめに思いつくと思われます。しかし、クリーン・アーキテクチャを理解するのに挫折する人も多く、池内氏はそれより学習コストの低いオニオン・アーキテクチャを使うことを提案しています。重要なことは、一番内側のレイヤーであるドメイン層は外側のレイヤーになるユースケース層、そしてさらに外側のレイヤーになるUI層やテスト層、ドメインオブジェクトの永続化を担当するインフラ層などに依存しないように設計することです。もちろん、ここでは依存性逆転の法則に則り、ドメイン層のインターフェースを利用するように設計します。Pythonはダックタイピングができる言語なのですが、インターフェースを定義することにより他の言語とアーキテクチャをそろえることができる上、型を明示して型ヒントやIDE、静的解析ツールなどのプログラミングツールの支援を受けやすくできるというメリットがあるわけです。オニオン・アーキテクチャにおいてはレイヤーの依存方向を整理し疎結合を維持するため、さらにはモック化しやすく、実装を差し替えやすいというメリットもあります。この、モック化のメリットはテストをしやすくするというメリットも付いてきます。その上で、インフラ層にはリポジトリパターンを採用し、ドメインオブジェクトの永続化処理をインターフェースをと実装に分けています。このリポジトリパターンには冗長であるという批判やRDBMSなどの変更がめったにないため抽象化するメリットがないという批判もありますが、これにはレイヤーの責務を明確にし、ドメインオブジェクトの隔離とテスタビリティの向上を目的とすることによって結果的にRDBMSの変更にも強くなるということを説いています。

この発想の源には、他の言語も開発に用いているという池内氏の経験が生きていると思います。池内氏はDartやGo、TypeScriptも開発に使っているとのことですが、インターフェースの仕様に関してはDartのような、インターフェースと実装の関連性を明示する仕様が一番好きと述べていますが、PythonでもABCモジュールを使うことによりインターフェースを書きやすくする事ができると述べています。

業務でPythonを書いたことがない私がAdvancedレベルのトークについて行けるのかと最初身構えてしまいましたが、実際にトークを聞いてみると設計が重要であるということ、特に現実の課題に関心を向けた明快な設計がコードを、そしてアプリケーションを理解しやすくするということを改めて考えさせられるよいトークでした。実際に池内氏が今回の講演のために用意した[サンプルコード](https://github.com/iktakahiro/dddpy)をご覧いただければ、理解はいっそう深まると思われます。
